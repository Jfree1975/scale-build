function load_video {
  if [ x$feature_all_video_module = xy ]; then
    insmod all_video
  else
    insmod efi_gop
    insmod efi_uga
    insmod ieee1275_fb
    insmod vbe
    insmod vga
    insmod video_bochs
    insmod video_cirrus
  fi
}

if loadfont $prefix/fonts/unicode.pf2 ; then
  set gfxmode=auto
  load_video
  insmod gfxterm
  insmod serial
  set locale_dir=$prefix/locale
  set lang=en_US
  set gfxpayload=keep
fi

serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1
terminal_output console serial
terminal_input console serial
# With serial input enabled, sleep helps consume buffered input
# grub.cfg generated by grub-install also includes the sleep for this purpose.
sleep -i 1

set menu_color_normal=cyan/blue
set menu_color_highlight=white/blue

if [ "${recordfail}" = 1 ] ; then
  set timeout=30
else
  if [ x$feature_timeout_style = xy ] ; then
#    set timeout_style=hidden
    set timeout=3
  # Fallback hidden-timeout code in case the timeout_style feature is
  # unavailable.
  elif sleep --interruptible 0 ; then
    set timeout=3
  fi
fi

insmod play
play 960 440 1 0 4 440 1
menuentry --hotkey=i 'Start TrueNAS SCALE Installation' {
    load_video
    set background_color=black
    linux    /vmlinuz gfxpayload=text quiet nomodeset boot=live toram=filesystem.squashfs console=tty0
    initrd   /initrd.img
}
menuentry --hotkey=j 'Start TrueNAS SCALE Installation (115200 baud)' {
    load_video
    set background_color=black
    linux    /vmlinuz gfxpayload=text quiet nomodeset boot=live toram=filesystem.squashfs console=ttyS0,115200 console=tty0
    initrd   /initrd.img
}
